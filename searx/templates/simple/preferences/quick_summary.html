<fieldset>{{- '' -}}
  <legend id="pref_quick_summary_enabled">{{ _('Quick Summary') }}</legend>{{- '' -}}
  <p class="value">{{- '' -}}
    <input type="checkbox" {{- ' ' -}}
           name="quick_summary_enabled" {{- ' ' -}}
           aria-labelledby="pref_quick_summary_enabled" {{- ' ' -}}
           class="checkbox-onoff" {{- ' ' -}}
           {%- if preferences.get_value('quick_summary_enabled') -%}
             checked
           {%- endif -%}{{- '' -}}
           >{{- '' -}}
  </p>{{- '' -}}
  <div class="description">
    {{- _('Enable AI-powered summary of search results') -}}
  </div>{{- '' -}}
</fieldset>{{- '' -}}

<fieldset>{{- '' -}}
  <legend id="pref_quick_summary_api">{{ _('API Configuration') }}</legend>{{- '' -}}
  <div class="value">{{- '' -}}
    <label for="pref_quick_summary_api_base_url">{{ _('API Base URL') }}</label>{{- '' -}}
    <input type="text" {{- ' ' -}}
           id="pref_quick_summary_api_base_url" {{- ' ' -}}
           name="quick_summary_api_base_url" {{- ' ' -}}
           aria-labelledby="pref_quick_summary_api" {{- ' ' -}}
           value="{{ preferences.get_value('quick_summary_api_base_url') or '' }}" {{- ' ' -}}
           placeholder="https://api.openai.com/v1"{{- '' -}}
    >{{- '' -}}
  </div>{{- '' -}}
  <div class="value">{{- '' -}}
    <label for="pref_quick_summary_api_key">{{ _('API Key') }}</label>{{- '' -}}
    <input type="password" {{- ' ' -}}
           id="pref_quick_summary_api_key" {{- ' ' -}}
           name="quick_summary_api_key" {{- ' ' -}}
           aria-labelledby="pref_quick_summary_api" {{- ' ' -}}
           value="{{ preferences.get_value('quick_summary_api_key') or '' }}" {{- ' ' -}}
           placeholder="{{ _('Enter your API key') }}"{{- '' -}}
           >{{- '' -}}
  </div>{{- '' -}}
  <div class="value">{{- '' -}}
    <label for="pref_quick_summary_model">{{ _('Model') }}</label>{{- '' -}}
    <input type="text" {{- ' ' -}}
           id="pref_quick_summary_model" {{- ' ' -}}
           name="quick_summary_model" {{- ' ' -}}
           aria-labelledby="pref_quick_summary_api" {{- ' ' -}}
           value="{{ preferences.get_value('quick_summary_model') or '' }}" {{- ' ' -}}
           placeholder="gpt-4o-mini"{{- '' -}}
           >{{- '' -}}
  </div>{{- '' -}}
  <div class="description">
    {{- _('Configure your OpenAI-compatible API endpoint and model') -}}
  </div>{{- '' -}}
</fieldset>{{- '' -}}

<fieldset>{{- '' -}}
  <legend id="pref_quick_summary_settings">{{ _('Summary Settings') }}</legend>{{- '' -}}
  <div class="value">{{- '' -}}
    <label for="pref_quick_summary_max_results">{{ _('Number of top results to summarize') }}</label>{{- '' -}}
    <input type="number" {{- ' ' -}}
           id="pref_quick_summary_max_results" {{- ' ' -}}
           name="quick_summary_max_results" {{- ' ' -}}
           aria-labelledby="pref_quick_summary_settings" {{- ' ' -}}
           value="{{ preferences.get_value('quick_summary_max_results') or '' }}" {{- ' ' -}}
           min="5" {{- ' ' -}}
           max="20" {{- ' ' -}}
           step="1"{{- '' -}}
           >{{- '' -}}
  </div>{{- '' -}}
  <div class="value">{{- '' -}}
    <label for="pref_quick_summary_prompt">{{ _('Custom Summary Prompt') }}</label>{{- '' -}}
    <textarea {{- ' ' -}}
           id="pref_quick_summary_prompt" {{- ' ' -}}
           aria-labelledby="pref_quick_summary_settings" {{- ' ' -}}
           rows="10" {{- ' ' -}}
           maxlength="5000" {{- ' ' -}}
           placeholder="{{ _('Leave empty to use default prompt. Use {query} for the search query and {results_text} for the formatted results.') }}"{{- '' -}}
    ></textarea>{{- '' -}}
    <input type="hidden" name="quick_summary_prompt" id="quick_summary_prompt_hidden" value="">
  </div>{{- '' -}}
  <div class="description">
    {{- _('Customize the prompt template for generating summaries. Available placeholders: {query}, {results_text}. Stored locally in your browser.') -}}
  </div>{{- '' -}}
</fieldset>{{- '' -}}

<script>
(function() {
  'use strict';
  
  var textarea = document.getElementById('pref_quick_summary_prompt');
  var hiddenInput = document.getElementById('quick_summary_prompt_hidden');
  var STORAGE_KEY = 'searxng_ai_custom_prompt';
  
  function loadPrompt() {
    try {
      var stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        textarea.value = stored;
      }
    } catch (e) {
      console.warn('Could not load prompt from localStorage:', e);
    }
  }
  
  function savePrompt() {
    try {
      localStorage.setItem(STORAGE_KEY, textarea.value);
    } catch (e) {
      console.warn('Could not save prompt to localStorage:', e);
    }
  }
  
  function updateHiddenField() {
    hiddenInput.value = textarea.value;
  }
  
  loadPrompt();
  
  textarea.addEventListener('input', function() {
    savePrompt();
    updateHiddenField();
  });
  
  updateHiddenField();
})();
</script>